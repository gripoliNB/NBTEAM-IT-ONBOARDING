<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Formulario - IT Solutions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background-image: url('logo.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .company-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #007bff;
            line-height: 1.2;
        }

        .company-tagline {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
            line-height: 1.2;
        }

        h1 {
            color: #333;
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }

        .form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .hardware-list, .training-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .hardware-details {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .form-col label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }

        .form-col input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-col input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .software-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .clients-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .radio-label, .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: normal;
        }

        .radio-label:hover, .checkbox-label:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }

        .radio-label input[type="radio"], .checkbox-label input[type="checkbox"] {
            margin: 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-text, .checkbox-text {
            font-size: 0.95rem;
            line-height: 1.4;
            color: #555;
        }

        .radio-label:has(input:checked) {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .radio-label:has(input:checked) .radio-text {
            color: #007bff;
            font-weight: 500;
        }

        .checkbox-label:has(input:checked) {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .checkbox-label:has(input:checked) .checkbox-text {
            color: #007bff;
            font-weight: 500;
        }

        .submit-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        .button-group .btn {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo {
                justify-content: center;
            }
            
            .logo-icon {
                font-size: 2rem;
            }
            
            .company-name {
                font-size: 1.2rem;
            }
            
            .company-tagline {
                font-size: 0.8rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .software-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">
                    <span class="company-name">NBTeam</span>
                    <span class="company-tagline">IT Onboarding</span>
                </div>
            </div>
            <div class="header-actions">
                <h1>Editar Formulario</h1>
                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToDashboard()">
                        üè† Dashboard
                    </button>
                    <button class="btn btn-info" onclick="goToList()">
                        üìã Lista de Formularios
                    </button>
                </div>
            </div>
        </div>

        <div id="message"></div>
        <div id="loading" class="loading">
            <p>Cargando formulario...</p>
        </div>

        <div class="actions">
            <a href="/list.html" class="btn btn-secondary">
                ‚Üê Volver a Lista
            </a>
        </div>

        <form id="employeeForm" class="form" style="display: none;">
            <div class="form-group">
                <label for="employeeNumber">N√∫mero de Empleado</label>
                <input
                    type="text"
                    id="employeeNumber"
                    name="employeeNumber"
                    placeholder="Ej: EMP001"
                />
            </div>

            <div class="form-group">
                <label for="fullName">Nombre Completo *</label>
                <input
                    type="text"
                    id="fullName"
                    name="fullName"
                    required
                    placeholder="Ej: Juan P√©rez Garc√≠a"
                />
            </div>

            <div class="form-group">
                <label for="emailPersonal">Correo Electr√≥nico Personal</label>
                <input
                    type="email"
                    id="emailPersonal"
                    name="emailPersonal"
                    placeholder="Ej: juan.perez@gmail.com"
                />
            </div>

            <div class="form-group">
                <label for="rol">Rol</label>
                <input
                    type="text"
                    id="rol"
                    name="rol"
                    placeholder="Ej: Desarrollador Senior, Analista de Sistemas"
                />
            </div>

            <div class="form-group">
                <label for="department">Departamento *</label>
                <select id="department" name="department" required>
                    <option value="">Selecciona un departamento</option>
                    <option value="Operacion">Operacion</option>
                    <option value="Soporte">Soporte</option>
                    <option value="Finanzas">Finanzas</option>
                    <option value="Ventas">Ventas</option>
                    <option value="Recursos Humanos">Recursos Humanos</option>
                </select>
            </div>

            <div class="form-group">
                <label for="startDate">Fecha de Inicio *</label>
                <input
                    type="date"
                    id="startDate"
                    name="startDate"
                    required
                />
            </div>

            <div class="form-group">
                <label>Hardware *</label>
                <div class="hardware-list">
                    <label class="radio-label">
                        <input type="radio" name="hardware" value="Windows Laptop (Standard)" required />
                        <span class="radio-text">Windows Laptop (Standard)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="hardware" value="MacBook Pro (Standard)" required />
                        <span class="radio-text">MacBook Pro (Standard)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="hardware" value="Escritorio Remoto" required />
                        <span class="radio-text">Escritorio Remoto</span>
                    </label>
                </div>
                
                <!-- Campos detallados del hardware -->
                <div class="hardware-details" id="hardwareDetails" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 14px;">Detalles del Hardware</h4>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="hardwareBrand">Marca</label>
                            <input type="text" id="hardwareBrand" name="hardwareBrand" placeholder="Ej: Dell, HP, Apple" />
                        </div>
                        <div class="form-col">
                            <label for="hardwareModel">Modelo</label>
                            <input type="text" id="hardwareModel" name="hardwareModel" placeholder="Ej: Latitude 5520, MacBook Pro 16" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="hardwareSerial">N√∫mero de Serie</label>
                            <input type="text" id="hardwareSerial" name="hardwareSerial" placeholder="N√∫mero de serie del equipo" />
                        </div>
                        <div class="form-col">
                            <label for="hardwareAccessories">Accesorios</label>
                            <input type="text" id="hardwareAccessories" name="hardwareAccessories" placeholder="Mouse, teclado, monitor, etc." />
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Capacitaciones *</label>
                <div class="training-list">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Onboarding de Seguridad" />
                        <span class="checkbox-text">Onboarding de Seguridad</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Explicar pol√≠ticas de seguridad de la informaci√≥n (uso de contrase√±as, acceso a redes, etc.)" />
                        <span class="checkbox-text">Explicar pol√≠ticas de seguridad de la informaci√≥n (uso de contrase√±as, acceso a redes, etc.)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Capacitaci√≥n b√°sica sobre uso de herramientas y aplicaciones internas" />
                        <span class="checkbox-text">Capacitaci√≥n b√°sica sobre uso de herramientas y aplicaciones internas</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Software Requerido *</label>
                <div class="software-list" id="softwareList">
                    <!-- Los checkboxes se generar√°n din√°micamente -->
                </div>
            </div>

            <div class="form-group">
                <label>Clientes Asignados</label>
                <div class="clients-list">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Evertec" />
                        <span class="checkbox-text">Evertec</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Triple S" />
                        <span class="checkbox-text">Triple S</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Monat" />
                        <span class="checkbox-text">Monat</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Hyundai" />
                        <span class="checkbox-text">Hyundai</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Daikin" />
                        <span class="checkbox-text">Daikin</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Cesar Castillo" />
                        <span class="checkbox-text">Cesar Castillo</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="observations">Observaciones</label>
                <textarea
                    id="observations"
                    name="observations"
                    placeholder="Observaciones adicionales (m√°ximo 100 caracteres)"
                    maxlength="100"
                    rows="3"
                ></textarea>
            </div>

            <div class="actions">
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        üíæ Solo Actualizar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="generatePDFAndSave()">
                        üìÑ Actualizar y Generar PDF
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Lista de software disponible
        const softwareList = [
            'Crear / Activar cuenta de correo electr√≥nico corporativo',
            'Power BI',
            'Appd financiera QuickBook',
            'Avast',
            'Microsoft 365',
            'Project',
            'Teams',
            'Bamboo',
            'Acrobat',
            'Dialpad',
            'Office 365',
            'Hubspot',
            'Harverst',
            'Pamet Each',
            'SAP for ME',
            'ZOOM',
            'Solman',
            'Acceso a impresoras y dispositivos'
        ];

        let formularioId = null;

        // Obtener ID del formulario desde la URL
        function getFormularioId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Variable para controlar si ya se est√° cargando
        let isLoading = false;
        
        // Funci√≥n principal de inicializaci√≥n
        function initializeForm() {
            if (isLoading) {
                console.log('Ya se est√° cargando, evitando duplicaci√≥n');
                return;
            }
            
            isLoading = true;
            console.log('Iniciando carga del formulario...');
            
            formularioId = getFormularioId();
            if (formularioId) {
                console.log('ID del formulario:', formularioId);
                
                // Generar checkboxes primero
                generateSoftwareCheckboxes();
                
                // Luego cargar el formulario
                loadFormulario(formularioId);
            } else {
                console.error('ID de formulario no v√°lido');
                showMessage('ID de formulario no v√°lido', 'error');
                isLoading = false;
            }
        }
        
        // Cargar formulario al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando...');
            initializeForm();
            
            // Fallback: si despu√©s de 10 segundos no se ha cargado, forzar la carga
            setTimeout(function() {
                if (isLoading) {
                    console.warn('Timeout alcanzado, forzando carga...');
                    const loadingElement = document.getElementById('loading');
                    const formElement = document.getElementById('employeeForm');
                    
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    if (formElement) {
                        formElement.style.display = 'block';
                    }
                    
                    isLoading = false;
                    showMessage('Formulario cargado con timeout', 'warning');
                }
            }, 10000);
        });

        // Generar checkboxes de software
        function generateSoftwareCheckboxes() {
            console.log('Generando checkboxes de software...');
            
            const softwareListDiv = document.getElementById('softwareList');
            if (!softwareListDiv) {
                console.error('Elemento softwareList no encontrado');
                return;
            }
            
            softwareListDiv.innerHTML = '';

            softwareList.forEach(software => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${software}" />
                    <span class="checkbox-text">${software}</span>
                `;
                softwareListDiv.appendChild(label);
            });
            
            console.log('Checkboxes de software generados exitosamente');
        }

        // Cargar datos del formulario
        async function loadFormulario(id) {
            try {
                console.log('Cargando formulario con ID:', id);
                
                const response = await fetch(`/api/formularios/${id}`, {
                    credentials: 'include'
                });
                
                console.log('Respuesta recibida, status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Resultado parseado:', result);

                if (result.success) {
                    const formulario = result.data;
                    console.log('Formulario cargado exitosamente:', formulario.full_name);
                    
                    // Llenar el formulario
                    populateForm(formulario);
                    
                    // Mostrar el formulario y ocultar loading
                    const loadingElement = document.getElementById('loading');
                    const formElement = document.getElementById('employeeForm');
                    
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                        console.log('Loading ocultado');
                    }
                    
                    if (formElement) {
                        formElement.style.display = 'block';
                        console.log('Formulario mostrado');
                    }
                    
                    // Resetear flag de carga
                    isLoading = false;
                    console.log('Carga completada exitosamente');
                    
                } else {
                    console.error('Error en respuesta:', result.error);
                    showMessage('Error al cargar formulario: ' + result.error, 'error');
                    isLoading = false;
                }
            } catch (error) {
                console.error('Error cargando formulario:', error);
                showMessage('Error de conexi√≥n: ' + error.message, 'error');
                isLoading = false;
            }
        }

        // Llenar el formulario con los datos
        function populateForm(formulario) {
            try {
                console.log('Llenando formulario con datos:', formulario);
                
                // Campos b√°sicos
                const employeeNumberField = document.getElementById('employeeNumber');
                const fullNameField = document.getElementById('fullName');
                const emailPersonalField = document.getElementById('emailPersonal');
                const rolField = document.getElementById('rol');
                const departmentField = document.getElementById('department');
                const startDateField = document.getElementById('startDate');
                
                if (employeeNumberField) employeeNumberField.value = formulario.employee_number || '';
                if (fullNameField) fullNameField.value = formulario.full_name || '';
                if (emailPersonalField) emailPersonalField.value = formulario.email_personal || '';
                if (rolField) rolField.value = formulario.rol || '';
                if (departmentField) departmentField.value = formulario.department || '';
                if (startDateField) startDateField.value = formulario.start_date || '';
                
                console.log('Campos b√°sicos llenados');
                
                // Seleccionar hardware
                if (formulario.hardware) {
                    const hardwareRadio = document.querySelector(`input[name="hardware"][value="${formulario.hardware}"]`);
                    if (hardwareRadio) {
                        hardwareRadio.checked = true;
                        console.log('Hardware seleccionado:', formulario.hardware);
                    }
                }

                // Llenar campos detallados del hardware
                const hardwareBrandField = document.getElementById('hardwareBrand');
                const hardwareModelField = document.getElementById('hardwareModel');
                const hardwareSerialField = document.getElementById('hardwareSerial');
                const hardwareAccessoriesField = document.getElementById('hardwareAccessories');
                
                if (hardwareBrandField) hardwareBrandField.value = formulario.hardware_brand || '';
                if (hardwareModelField) hardwareModelField.value = formulario.hardware_model || '';
                if (hardwareSerialField) hardwareSerialField.value = formulario.hardware_serial || '';
                if (hardwareAccessoriesField) hardwareAccessoriesField.value = formulario.hardware_accessories || '';
                
                console.log('Campos de hardware llenados');

                // Seleccionar capacitaciones
                if (formulario.trainings && Array.isArray(formulario.trainings)) {
                    formulario.trainings.forEach(training => {
                        const checkbox = document.querySelector(`input[value="${training}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log('Capacitaciones seleccionadas:', formulario.trainings.length);
                }

                // Seleccionar software
                if (formulario.software_requirements && Array.isArray(formulario.software_requirements)) {
                    formulario.software_requirements.forEach(software => {
                        const checkbox = document.querySelector(`input[value="${software}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log('Software seleccionado:', formulario.software_requirements.length);
                }

                // Seleccionar clientes
                if (formulario.clients && Array.isArray(formulario.clients)) {
                    formulario.clients.forEach(client => {
                        const checkbox = document.querySelector(`input[value="${client}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    console.log('Clientes seleccionados:', formulario.clients.length);
                }

                // Llenar observaciones
                const observationsField = document.getElementById('observations');
                if (observationsField) {
                    observationsField.value = formulario.observations || '';
                    console.log('Observaciones llenadas');
                }
                
                console.log('Formulario llenado exitosamente');
                
            } catch (error) {
                console.error('Error llenando formulario:', error);
                showMessage('Error llenando formulario: ' + error.message, 'error');
            }
        }

        // Manejar env√≠o del formulario
        document.getElementById('employeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const employeeNumber = formData.get('employeeNumber');
            const fullName = formData.get('fullName');
            const emailPersonal = formData.get('emailPersonal');
            const rol = formData.get('rol');
            const department = formData.get('department');
            const startDate = formData.get('startDate');
            const hardware = formData.get('hardware');
            
            // Obtener detalles del hardware
            const hardwareBrand = formData.get('hardwareBrand') || '';
            const hardwareModel = formData.get('hardwareModel') || '';
            const hardwareSerial = formData.get('hardwareSerial') || '';
            const hardwareAccessories = formData.get('hardwareAccessories') || '';
            
            // Obtener capacitaciones seleccionadas
            const selectedTrainings = Array.from(document.querySelectorAll('.training-list input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            
            // Obtener software seleccionado
            const selectedSoftware = Array.from(document.querySelectorAll('.software-list input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            
            // Obtener clientes seleccionados
            const selectedClients = Array.from(document.querySelectorAll('.clients-list input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            const observations = formData.get('observations') || '';
            
            const data = {
                employeeNumber,
                fullName,
                emailPersonal,
                rol,
                department,
                startDate,
                hardware,
                hardwareBrand,
                hardwareModel,
                hardwareSerial,
                hardwareAccessories,
                trainings: selectedTrainings,
                softwareRequirements: selectedSoftware,
                clients: selectedClients,
                observations: observations,
                updatedBy: currentUser
            };
            
            try {
                const response = await fetch(`/api/formularios/${formularioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('¬°Formulario actualizado exitosamente!', 'success');
                    setTimeout(() => {
                        window.location.href = '/list.html';
                    }, 2000);
                } else {
                    showMessage('Error al actualizar: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n: ' + error.message, 'error');
            }
        });

        // Funci√≥n para generar PDF y actualizar formulario
        async function generatePDFAndSave() {
            console.log('Iniciando actualizaci√≥n y generaci√≥n de PDF...');
            
            try {
                // Primero validar el formulario
                const form = document.getElementById('employeeForm');
                const formData = new FormData(form);
                
                const employeeNumber = formData.get('employeeNumber');
                const fullName = formData.get('fullName');
                const emailPersonal = formData.get('emailPersonal');
                const rol = formData.get('rol');
                const department = formData.get('department');
                const startDate = formData.get('startDate');
                const hardware = formData.get('hardware');
                
                // Obtener detalles del hardware
                const hardwareBrand = formData.get('hardwareBrand') || '';
                const hardwareModel = formData.get('hardwareModel') || '';
                const hardwareSerial = formData.get('hardwareSerial') || '';
                const hardwareAccessories = formData.get('hardwareAccessories') || '';
                
                // Obtener capacitaciones seleccionadas
                const selectedTrainings = Array.from(document.querySelectorAll('.training-list input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Obtener software seleccionado
                const selectedSoftware = Array.from(document.querySelectorAll('.software-list input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Obtener clientes seleccionados
                const selectedClients = Array.from(document.querySelectorAll('.clients-list input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Obtener observaciones
                const observations = formData.get('observations') || '';
                
                // Validaciones
                if (!fullName || !department || !startDate || !hardware) {
                    showMessage('Por favor, completa todos los campos obligatorios.', 'error');
                    return;
                }
                
                if (selectedTrainings.length === 0) {
                    showMessage('Por favor, selecciona al menos una capacitaci√≥n.', 'error');
                    return;
                }
                
                if (selectedSoftware.length === 0) {
                    showMessage('Por favor, selecciona al menos un software requerido.', 'error');
                    return;
                }
                
                // Obtener usuario actual de la sesi√≥n
                let currentUser = 'Usuario An√≥nimo';
                try {
                    const userResponse = await fetch('/api/auth/check', {
                        credentials: 'include'
                    });
                    const userResult = await userResponse.json();
                    if (userResult.success && userResult.user) {
                        currentUser = userResult.user.username || userResult.user.name || 'Usuario';
                    }
                } catch (error) {
                    console.log('No se pudo obtener usuario actual:', error);
                }

                // Crear objeto con los datos
                const data = {
                    employeeNumber,
                    fullName,
                    emailPersonal,
                    rol,
                    department,
                    startDate,
                    hardware,
                    hardwareBrand,
                    hardwareModel,
                    hardwareSerial,
                    hardwareAccessories,
                    trainings: selectedTrainings,
                    softwareRequirements: selectedSoftware,
                    clients: selectedClients,
                    observations: observations,
                    updatedBy: currentUser
                };
                
                console.log('Actualizando formulario...');
                
                // Actualizar en base de datos
                const response = await fetch(`/api/formularios/${formularioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Formulario actualizado exitosamente');
                    showMessage('Formulario actualizado exitosamente', 'success');
                    
                    // Ahora generar el PDF
                    console.log('Generando PDF...');
                    try {
                        await generatePDFDocument(data);
                        showMessage('PDF generado y descargado exitosamente', 'success');
                        
                        // En modo edici√≥n, no limpiamos el formulario, solo mostramos mensaje
                        console.log('Formulario actualizado y PDF generado');
                        
                    } catch (pdfError) {
                        console.error('Error generando PDF:', pdfError);
                        showMessage('Formulario actualizado, pero error al generar PDF: ' + pdfError.message, 'warning');
                    }
                } else {
                    console.error('Error actualizando formulario:', result.error);
                    showMessage('Error al actualizar formulario: ' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('Error en generatePDFAndSave:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        document.getElementById('employeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const employeeNumber = formData.get('employeeNumber');
            const fullName = formData.get('fullName');
            const emailPersonal = formData.get('emailPersonal');
            const rol = formData.get('rol');
            const department = formData.get('department');
            const startDate = formData.get('startDate');
            const hardware = formData.get('hardware');
            
            // Obtener detalles del hardware
            const hardwareBrand = formData.get('hardwareBrand') || '';
            const hardwareModel = formData.get('hardwareModel') || '';
            const hardwareSerial = formData.get('hardwareSerial') || '';
            const hardwareAccessories = formData.get('hardwareAccessories') || '';
            
            // Obtener capacitaciones seleccionadas
            const selectedTrainings = Array.from(document.querySelectorAll('.training-list input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Obtener software seleccionado
            const selectedSoftware = Array.from(document.querySelectorAll('.software-list input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Obtener clientes seleccionados
            const selectedClients = Array.from(document.querySelectorAll('.clients-list input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Obtener observaciones
            const observations = formData.get('observations') || '';
            
            // Validaciones
            if (!fullName || !department || !startDate || !hardware) {
                showMessage('Por favor, completa todos los campos obligatorios.', 'error');
                return;
            }
            
            if (selectedTrainings.length === 0) {
                showMessage('Por favor, selecciona al menos una capacitaci√≥n.', 'error');
                return;
            }
            
            if (selectedSoftware.length === 0) {
                showMessage('Por favor, selecciona al menos un software requerido.', 'error');
                return;
            }
            
            // Obtener usuario actual de la sesi√≥n
            let currentUser = 'Usuario An√≥nimo';
            try {
                const userResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const userResult = await userResponse.json();
                if (userResult.success && userResult.user) {
                    currentUser = userResult.user.username || userResult.user.name || 'Usuario';
                }
            } catch (error) {
                console.log('No se pudo obtener usuario actual:', error);
            }

            // Crear objeto con los datos
            const data = {
                employeeNumber,
                fullName,
                emailPersonal,
                rol,
                department,
                startDate,
                hardware,
                hardwareBrand,
                hardwareModel,
                hardwareSerial,
                hardwareAccessories,
                trainings: selectedTrainings,
                softwareRequirements: selectedSoftware,
                clients: selectedClients,
                observations: observations,
                updatedBy: currentUser
            };
            
            // Debug: Verificar valores de hardware
            console.log('üîç Debug Hardware (Edit):', {
                hardwareBrand: hardwareBrand,
                hardwareModel: hardwareModel,
                hardwareSerial: hardwareSerial,
                hardwareAccessories: hardwareAccessories
            });
            
            // Solo actualizar formulario
            try {
                const response = await fetch(`/api/formularios/${formularioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('¬°Formulario actualizado exitosamente!', 'success');
                    setTimeout(() => {
                        window.location.href = '/list.html';
                    }, 2000);
                } else {
                    showMessage('Error al actualizar: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n: ' + error.message, 'error');
            }
        });

        // Funci√≥n para mostrar mensajes
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            if (text) {
                messageDiv.innerHTML = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                // Ocultar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            } else {
                messageDiv.style.display = 'none';
            }
        }

        // Funci√≥n para convertir imagen a base64
        function imageToBase64(imagePath) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                // Timeout para evitar que se cuelgue
                const timeout = setTimeout(() => {
                    console.log('Timeout al cargar imagen del logo, usando versi√≥n de texto');
                    resolve(null);
                }, 3000);
                
                img.onload = function() {
                    clearTimeout(timeout);
                    try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/jpeg');
                    resolve(dataURL);
                    } catch (error) {
                        console.log('Error al procesar imagen del logo:', error);
                        resolve(null);
                    }
                };
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    console.log('No se pudo cargar la imagen del logo, usando versi√≥n de texto');
                    resolve(null);
                };
                
                img.src = imagePath;
            });
        }

        // Funci√≥n para generar documento PDF
        async function generatePDFDocument(formData) {
            console.log('Iniciando generaci√≥n de PDF con datos:', formData);
            
            try {
                // Verificar que jsPDF est√© disponible
                if (!window.jspdf) {
                    throw new Error('jsPDF no est√° cargado. Verifica la conexi√≥n a internet.');
                }
                
                const { jsPDF } = window.jspdf;
                console.log('jsPDF cargado:', !!jsPDF);
                
                if (!jsPDF) {
                    throw new Error('jsPDF no est√° disponible en window.jspdf');
                }
                
                const doc = new jsPDF();
                console.log('Documento PDF creado');
                
                // Configuraci√≥n de p√°ginas
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentHeight = pageHeight - (margin * 2);
                const footerHeight = 30;
                const maxContentHeight = contentHeight - footerHeight;
                
                console.log('Configuraci√≥n de p√°ginas:', {
                    pageHeight,
                    pageWidth,
                    margin,
                    contentHeight,
                    maxContentHeight
                });
                
                // Configuraci√≥n de colores
                const primaryColor = [0, 123, 255]; // Azul corporativo
                const textColor = [51, 51, 51]; // Gris oscuro
                const lightGray = [200, 200, 200]; // Gris claro
                
                // Funci√≥n auxiliar para manejar salto de p√°gina
                function checkPageBreak(yPosition, lineHeight = 6) {
                    if (yPosition + lineHeight > maxContentHeight) {
                        doc.addPage();
                        console.log('Nueva p√°gina agregada');
                        return margin + 20; // Volver al inicio de la nueva p√°gina
                    }
                    return yPosition;
                }
                
                // Funci√≥n auxiliar para agregar texto con salto de p√°gina autom√°tico
                function addTextWithPageBreak(text, x, y, options = {}) {
                    const { maxWidth = 160, fontSize = 10, fontStyle = 'normal' } = options;
                    
                    doc.setFontSize(fontSize);
                    doc.setFont('helvetica', fontStyle);
                    
                    // Dividir texto en l√≠neas si es necesario
                    const lines = doc.splitTextToSize(text, maxWidth);
                    
                    let currentY = y;
                    lines.forEach(line => {
                        currentY = checkPageBreak(currentY, lineHeight);
                        doc.text(line, x, currentY);
                        currentY += lineHeight;
                    });
                    
                    return currentY;
                }
                
                // Intentar cargar el logo real
                let logoBase64 = null;
                try {
                    logoBase64 = await imageToBase64('logo.jpg');
                } catch (error) {
                    console.log('Error al cargar logo:', error);
                }
                
                // Logo en la parte superior izquierda
                if (logoBase64) {
                    // Usar imagen real del logo
                    doc.addImage(logoBase64, 'JPEG', 20, 15, 30, 20);
                    console.log('Logo de imagen agregado al PDF');
                } else {
                    // Usar versi√≥n de texto del logo
                    doc.setFillColor(40, 167, 69); // Verde del logo
                    doc.roundedRect(20, 15, 30, 20, 3, 3, 'F');
                    
                    // Texto del logo (simulando la imagen)
                    doc.setFontSize(8);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NBTeam', 25, 25);
                    doc.setFontSize(6);
                    doc.text('IT', 25, 30);
                    console.log('Logo de texto agregado al PDF');
                }
                
                // T√≠tulo principal (m√°s a la derecha para dar espacio al logo)
                doc.setFontSize(20);
                doc.setTextColor(...primaryColor);
                doc.setFont('helvetica', 'bold');
                doc.text('FORMULARIO DE EMPLEADO', 60, 30);
                
                // L√≠nea decorativa
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(0.5);
                doc.line(20, 35, 190, 35);
            
            // Informaci√≥n del empleado
            doc.setFontSize(12);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'normal');
            
            let yPosition = 50;
            const lineHeight = 8;
            
            // Funci√≥n auxiliar para agregar texto con verificaci√≥n de p√°gina
            function addText(label, value, isBold = false) {
                yPosition = checkPageBreak(yPosition, lineHeight);
                
                if (isBold) {
                    doc.setFont('helvetica', 'bold');
                } else {
                    doc.setFont('helvetica', 'normal');
                }
                
                doc.text(label, 20, yPosition);
                doc.setFont('helvetica', 'normal');
                doc.text(value || 'No especificado', 80, yPosition);
                yPosition += lineHeight;
            }
            
            // Funci√≥n auxiliar para agregar lista con verificaci√≥n de p√°gina
            function addList(title, items, indent = 25) {
                yPosition = checkPageBreak(yPosition, lineHeight);
                doc.setFont('helvetica', 'bold');
                doc.text(title, 20, yPosition);
                yPosition += lineHeight;
                
                doc.setFont('helvetica', 'normal');
                items.forEach(item => {
                    yPosition = checkPageBreak(yPosition, lineHeight);
                    doc.text(`‚Ä¢ ${item}`, indent, yPosition);
                    yPosition += lineHeight;
                });
                yPosition += 5;
            }
            
            // Agregar informaci√≥n del empleado usando funciones auxiliares
            addText('N√∫mero de Empleado:', formData.employeeNumber);
            addText('Nombre Completo:', formData.fullName);
            
            if (formData.emailPersonal && formData.emailPersonal.trim()) {
                addText('Correo Electr√≥nico Personal:', formData.emailPersonal);
            }
            
            if (formData.rol && formData.rol.trim()) {
                addText('Rol:', formData.rol);
            }
            
            addText('Departamento:', formData.department);
            addText('Fecha de Inicio:', formData.startDate);
            addText('Hardware (Laptop):', formData.hardware);
            
            // Detalles del hardware si est√°n disponibles
            if (formData.hardwareBrand || formData.hardwareModel || formData.hardwareSerial || formData.hardwareAccessories) {
                yPosition = checkPageBreak(yPosition, lineHeight);
                doc.setFont('helvetica', 'bold');
                doc.text('Detalles del Hardware:', 20, yPosition);
                yPosition += lineHeight;
                
                doc.setFont('helvetica', 'normal');
                if (formData.hardwareBrand) {
                    yPosition = checkPageBreak(yPosition, lineHeight);
                    doc.text(`‚Ä¢ Marca: ${formData.hardwareBrand}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                if (formData.hardwareModel) {
                    yPosition = checkPageBreak(yPosition, lineHeight);
                    doc.text(`‚Ä¢ Modelo: ${formData.hardwareModel}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                if (formData.hardwareSerial) {
                    yPosition = checkPageBreak(yPosition, lineHeight);
                    doc.text(`‚Ä¢ N√∫mero de Serie: ${formData.hardwareSerial}`, 25, yPosition);
                    yPosition += lineHeight;
                }
                if (formData.hardwareAccessories) {
                    yPosition = checkPageBreak(yPosition, lineHeight);
                    doc.setFont('helvetica', 'normal');
                    // Usar la funci√≥n auxiliar para texto largo
                    yPosition = addTextWithPageBreak(`‚Ä¢ Accesorios: ${formData.hardwareAccessories}`, 25, yPosition, { maxWidth: 160 });
                }
                yPosition += 5;
            }
            
            // Capacitaciones
            addList('Capacitaciones:', formData.trainings);
            
            // Software requerido
            addList('Software Requerido:', formData.softwareRequirements);
            
            // Clientes asignados
            if (formData.clients && formData.clients.length > 0) {
                addList('Clientes Asignados:', formData.clients);
            }
            
            // Observaciones
            if (formData.observations && formData.observations.trim()) {
                yPosition = checkPageBreak(yPosition, lineHeight);
                doc.setFont('helvetica', 'bold');
                doc.text('Observaciones:', 20, yPosition);
                yPosition += lineHeight;
                
                // Usar la funci√≥n auxiliar para texto largo
                yPosition = addTextWithPageBreak(formData.observations, 25, yPosition, { maxWidth: 160 });
                yPosition += 5;
            }
            
            // Fecha de generaci√≥n
            yPosition = checkPageBreak(yPosition, lineHeight);
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Documento generado el ${new Date().toLocaleDateString('es-ES')}`, 20, yPosition);
            
            // Agregar pie de p√°gina a todas las p√°ginas
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Pie de p√°gina con logo
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('NBTeam - IT Onboarding System', 20, pageHeight - 15);
                
                // N√∫mero de p√°gina (m√°s hacia la izquierda para evitar conflicto con logo)
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth - 60, pageHeight - 15);
                
                // Logo peque√±o en el pie de p√°gina (m√°s hacia la derecha)
                if (logoBase64) {
                    doc.addImage(logoBase64, 'JPEG', pageWidth - 25, pageHeight - 20, 12, 8);
                } else {
                    doc.setFillColor(40, 167, 69);
                    doc.roundedRect(pageWidth - 25, pageHeight - 20, 12, 8, 2, 2, 'F');
                    doc.setFontSize(5);
                    doc.setTextColor(255, 255, 255);
                    doc.text('NB', pageWidth - 22, pageHeight - 15);
                }
            }
            
            // Crear nombre de archivo
            const employeeNumber = formData.employeeNumber || 'Sin_Numero';
            const fileName = `Empleado_${employeeNumber}_${formData.fullName.replace(/\s+/g, '_')}.pdf`;
            
            // Descargar el PDF
            doc.save(fileName);
            console.log('PDF generado y descargado exitosamente');
            
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showMessage('Error al generar PDF: ' + error.message, 'error');
            }
        }

        // Funci√≥n de respaldo para generar PDF b√°sico
        function generateBasicPDF(formData) {
            console.log('Generando PDF b√°sico como respaldo...');
            
            try {
                // Crear contenido HTML para imprimir
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Formulario de Onboarding - ${formData.fullName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .logo { background-color: #28a745; color: white; padding: 10px; display: inline-block; border-radius: 5px; }
                            .section { margin: 20px 0; }
                            .section h3 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
                            .field { margin: 10px 0; }
                            .field strong { display: inline-block; width: 150px; }
                            .list { margin-left: 20px; }
                            .list li { margin: 5px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo">NBTeam IT</div>
                            <h1>Formulario de Onboarding</h1>
                        </div>
                        
                        <div class="section">
                            <h3>Informaci√≥n del Empleado</h3>
                            <div class="field"><strong>N√∫mero de Empleado:</strong> ${formData.employeeNumber || 'N/A'}</div>
                            <div class="field"><strong>Nombre Completo:</strong> ${formData.fullName}</div>
                            <div class="field"><strong>Departamento:</strong> ${formData.department}</div>
                            <div class="field"><strong>Fecha de Inicio:</strong> ${formData.startDate}</div>
                        </div>
                        
                        <div class="section">
                            <h3>Hardware Asignado</h3>
                            <div class="field"><strong>Tipo:</strong> ${formData.hardware}</div>
                            <div class="field"><strong>Marca:</strong> ${formData.hardwareBrand || 'N/A'}</div>
                            <div class="field"><strong>Modelo:</strong> ${formData.hardwareModel || 'N/A'}</div>
                            <div class="field"><strong>N√∫mero de Serie:</strong> ${formData.hardwareSerial || 'N/A'}</div>
                            <div class="field"><strong>Accesorios:</strong> ${formData.hardwareAccessories || 'N/A'}</div>
                        </div>
                        
                        <div class="section">
                            <h3>Capacitaciones</h3>
                            <ul class="list">
                                ${formData.trainings.map(training => `<li>${training}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="section">
                            <h3>Software Requerido</h3>
                            <ul class="list">
                                ${formData.softwareRequirements.map(software => `<li>${software}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="section">
                            <p><strong>Fecha de Generaci√≥n:</strong> ${new Date().toLocaleDateString()}</p>
                            <p><strong>Creado por:</strong> ${formData.createdBy || 'Usuario'}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Crear ventana de impresi√≥n
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // Esperar a que se cargue y luego imprimir
                printWindow.onload = function() {
                    printWindow.print();
                    printWindow.close();
                };
                
                console.log('PDF b√°sico generado exitosamente');
                return true;
                
            } catch (error) {
                console.error('Error generando PDF b√°sico:', error);
                return false;
            }
        }

        // Funci√≥n para ir al dashboard
        function goToDashboard() {
            window.location.href = '/dashboard.html';
        }

        // Funci√≥n para ir a la lista de formularios
        function goToList() {
            window.location.href = '/list.html';
        }
    </script>
</body>
</html>
